name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Check if release exists
        id: check_release
        run: |
          if gh release view ${{ steps.version.outputs.VERSION }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release already exists (created by local release.sh)"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Only create release if it doesn't exist (backup for non-local releases)
      - name: Create source archive
        if: steps.check_release.outputs.exists == 'false'
        run: |
          mkdir -p dist
          zip -r dist/Animus-${{ steps.version.outputs.VERSION }}-source.zip \
            *.pde \
            data/ \
            README.md \
            build.sh \
            build-macos.sh \
            env.example \
            sketch.properties \
            -x "*.DS_Store"
      
      - name: Create GitHub Release (fallback)
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          name: Animus ${{ steps.version.outputs.VERSION }}
          body: |
            ## ðŸŽµ Animus Audio Visualizer ${{ steps.version.outputs.VERSION }}

            ### From Source
            1. Download and install [Processing 4.3+](https://processing.org/download)
            2. Install libraries: Sketch â†’ Import Library â†’ Manage Libraries â†’ search 'Minim' and 'ControlP5'
            3. Download the source zip below and extract
            4. Open `Animus.pde` in Processing and click Run

            ### ðŸ”Š System Audio Setup (macOS)
            To visualize Spotify, Apple Music, or other apps:
            - Use [Loopback](https://rogueamoeba.com/loopback/) or [SoundSource](https://rogueamoeba.com/soundsource/) to route audio
            - Set the virtual audio device as your system input in **System Settings â†’ Sound â†’ Input**

            > **Note:** For pre-built macOS binary, use `./release.sh` locally (requires Apple Developer account for signing/notarization)
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          files: |
            dist/Animus-${{ steps.version.outputs.VERSION }}-source.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
